<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nền tảng học tập</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
            font-weight: 700;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .user-info {
            background: rgba(52, 152, 219, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }

        .user-info.show {
            display: block;
        }

        .login-form {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .login-form input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .login-form button {
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .login-form button:hover {
            background: #2980b9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 30px;
            align-items: start;
        }

        .course-sidebar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 20px;
        }

        .course-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e74c3c;
        }

        .progress-bar {
            background: #ecf0f1;
            height: 8px;
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #2ecc71, #27ae60);
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
            width: 0%;
        }

        .lesson-list {
            list-style: none;
        }

        .lesson-item {
            background: #f8f9fa;
            margin-bottom: 10px;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .lesson-item:hover {
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.2);
        }

        .lesson-item.active {
            border-color: #e74c3c;
            background: #fff5f5;
        }

        .lesson-header {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            color: #2c3e50;
        }

        .lesson-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: #ffffff;
        }

        .lesson-item.expanded .lesson-content {
            max-height: 300px;
        }

        .topic-list {
            list-style: none;
            padding: 0 15px 15px;
        }

        .topic-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            color: #555;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 5px;
            padding-left: 10px;
        }

        .topic-item:hover {
            background: #f1f3f4;
            color: #2c3e50;
        }

        .topic-item.completed {
            color: #27ae60;
            font-weight: 500;
        }

        .checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid #bdc3c7;
            border-radius: 3px;
            margin-right: 10px;
            position: relative;
            transition: all 0.2s ease;
        }

        .checkbox.checked {
            background: #27ae60;
            border-color: #27ae60;
        }

        .checkbox.checked::after {
            content: '✓';
            color: white;
            position: absolute;
            top: -2px;
            left: 2px;
            font-size: 12px;
            font-weight: bold;
        }

        .content-area {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            min-height: 600px;
        }

        .lesson-detail h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 2em;
            font-weight: 600;
        }

        .lesson-detail h3 {
            color: #34495e;
            margin: 25px 0 15px;
            font-size: 1.4em;
            font-weight: 500;
            border-left: 4px solid #e74c3c;
            padding-left: 15px;
        }

        .lesson-detail p {
            color: #555;
            line-height: 1.8;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .complete-btn {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            margin-top: 30px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
        }

        .complete-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4);
        }

        .complete-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            flex: 1;
        }

        .stat-number {
            font-size: 1.5em;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .expand-icon {
            transition: transform 0.3s ease;
        }

        .lesson-item.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .welcome-screen {
            text-align: center;
            color: #7f8c8d;
            padding: 100px 20px;
        }

        .welcome-screen h2 {
            margin-bottom: 15px;
            font-size: 2em;
            color: #2c3e50;
        }

        .welcome-screen p {
            font-size: 1.2em;
            line-height: 1.6;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #7f8c8d;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #ddd;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            text-align: center;
        }

        .success {
            background: #2ecc71;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            text-align: center;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .course-sidebar {
                position: static;
            }

            .header h1 {
                font-size: 2em;
            }

            .content-area {
                padding: 20px;
            }

            .login-form {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎓 Nền tảng học tập trực tuyến</h1>
            <p>Nơi bạn khám phá kiến thức và phát triển kỹ năng</p>
            
            <!-- Login Form -->
            <div class="login-form" id="loginForm">
                <input type="email" id="userEmail" placeholder="Email của bạn">
                <input type="text" id="userName" placeholder="Tên của bạn">
                <button onclick="loginUser()">Đăng nhập/Đăng ký</button>
            </div>

            <!-- User Info -->
            <div class="user-info" id="userInfo">
                <span id="welcomeMessage"></span>
                <button onclick="logoutUser()" style="float: right; background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">Đăng xuất</button>
            </div>
        </div>

        <div class="main-content">
            <div class="course-sidebar">
                <h2 class="course-title">📚 Khóa học Toán học cơ bản</h2>
                
                <div class="stats">
                    <div class="stat-item">
                        <span class="stat-number" id="completedCount">0</span>
                        <span class="stat-label">Đã hoàn thành</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="totalCount">0</span>
                        <span class="stat-label">Tổng cộng</span>
                    </div>
                </div>
                
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>

                <ul class="lesson-list" id="lessonList">
                    <div class="loading">Đang tải dữ liệu...</div>
                </ul>
            </div>

            <div class="content-area">
                <div id="lessonDetail" class="lesson-detail">
                    <div class="welcome-screen">
                        <h2>Chào mừng bạn đến với khóa học!</h2>
                        <p>Vui lòng đăng nhập và chọn một bài học từ menu bên trái để bắt đầu hành trình học tập của bạn. Mỗi bài học được thiết kế để giúp bạn nắm vững kiến thức một cách hiệu quả nhất.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Cấu hình API
        const API_CONFIG = {
            BASE_URL: 'https://script.google.com/macros/s/AKfycbyUP1EbxYxwWrLKr3dUDY01FIT3Ij4Vkx5yvyRXjhBdBKtYUYW6Hb01gSL1h59yolDzBg/exec', // Thay bằng URL thực của bạn
            COURSE_ID: 1
        };

        // Biến global
        let currentUser = null;
        let currentLesson = null;
        let currentTopic = null;
        let courseData = null;
        let userProgress = [];

        // ========================================
        // USER AUTHENTICATION
        // ========================================

        async function loginUser() {
            const email = document.getElementById('userEmail').value.trim();
            const name = document.getElementById('userName').value.trim();

            if (!email || !name) {
                showError('Vui lòng nhập đầy đủ email và tên');
                return;
            }

            try {
                showLoading('Đang đăng nhập...');

                // Thử đăng nhập trước
                let response = await fetch(`${API_CONFIG.BASE_URL}?action=loginUser`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'loginUser',
                        email: email
                    })
                });

                let result = await response.json();

                // Nếu user không tồn tại, tạo mới
                if (!result.success) {
                    response = await fetch(`${API_CONFIG.BASE_URL}?action=createUser`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: 'createUser',
                            email: email,
                            name: name
                        })
                    });

                    result = await response.json();
                }

                if (result.success) {
                    currentUser = result.user;
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('userInfo').classList.add('show');
                    document.getElementById('welcomeMessage').textContent = `Xin chào, ${currentUser.name}!`;
                    
                    showSuccess('Đăng nhập thành công!');
                    await loadCourseData();
                } else {
                    showError(result.message || 'Đăng nhập thất bại');
                }
            } catch (error) {
                console.error('Login error:', error);
                showError('Có lỗi xảy ra khi đăng nhập. Vui lòng thử lại.');
            }
        }

        function logoutUser() {
            currentUser = null;
            currentLesson = null;
            currentTopic = null;
            userProgress = [];
            
            document.getElementById('loginForm').style.display = 'flex';
            document.getElementById('userInfo').classList.remove('show');
            document.getElementById('userEmail').value = '';
            document.getElementById('userName').value = '';
            
            // Reset UI
            document.getElementById('lessonList').innerHTML = '<div class="loading">Vui lòng đăng nhập để xem nội dung</div>';
            document.getElementById('lessonDetail').innerHTML = `
                <div class="welcome-screen">
                    <h2>Chào mừng bạn đến với khóa học!</h2>
                    <p>Vui lòng đăng nhập và chọn một bài học từ menu bên trái để bắt đầu hành trình học tập của bạn.</p>
                </div>
            `;
            updateProgress();
        }

        // ========================================
        // DATA LOADING
        // ========================================

        async function loadCourseData() {
            if (!currentUser) return;

            try {
                showLoading('Đang tải khóa học...');

                // Load course data
                const courseResponse = await fetch(`${API_CONFIG.BASE_URL}?action=getCourseData&courseId=${API_CONFIG.COURSE_ID}`);
                courseData = await courseResponse.json();

                // Load user progress
                const progressResponse = await fetch(`${API_CONFIG.BASE_URL}?action=getUserProgress&userId=${currentUser.id}`);
                userProgress = await progressResponse.json();

                // Update course data with user progress
                updateCourseWithProgress();
                
                // Initialize UI
                initializeLessons();
                updateProgress();

                hideLoading();
            } catch (error) {
                console.error('Error loading course data:', error);
                showError('Có lỗi xảy ra khi tải dữ liệu khóa học');
            }
        }

        function updateCourseWithProgress() {
            if (!courseData || !userProgress) return;

            const completedTopics = new Set(
                userProgress.filter(p => p.completed).map(p => p.topicId)
            );

            courseData.lessons.forEach(lesson => {
                lesson.topics.forEach(topic => {
                    topic.completed = completedTopics.has(topic.id);
                });
            });
        }

        // ========================================
        // UI FUNCTIONS
        // ========================================

        function initializeLessons() {
            if (!courseData) return;

            const lessonList = document.getElementById('lessonList');
            lessonList.innerHTML = '';
            
            courseData.lessons.forEach(lesson => {
                const lessonItem = document.createElement('li');
                lessonItem.className = 'lesson-item';
                lessonItem.innerHTML = `
                    <div class="lesson-header" onclick="toggleLesson(${lesson.id})">
                        <span>${lesson.title}</span>
                        <span class="expand-icon">▼</span>
                    </div>
                    <div class="lesson-content">
                        <ul class="topic-list">
                            ${lesson.topics.map(topic => `
                                <li class="topic-item ${topic.completed ? 'completed' : ''}" onclick="selectTopic(${lesson.id}, ${topic.id})">
                                    <div class="checkbox ${topic.completed ? 'checked' : ''}" id="checkbox-${lesson.id}-${topic.id}"></div>
                                    <span>${topic.name}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
                lessonList.appendChild(lessonItem);
            });
        }

        function toggleLesson(lessonId) {
            const lessonItems = document.querySelectorAll('.lesson-item');
            lessonItems.forEach(item => {
                const header = item.querySelector('.lesson-header');
                if (header.onclick.toString().includes(lessonId)) {
                    item.classList.toggle('expanded');
                    
                    // Remove active class from all items first
                    lessonItems.forEach(li => li.classList.remove('active'));
                    
                    // Add active class to current item if expanded
                    if (item.classList.contains('expanded')) {
                        item.classList.add('active');
                    }
                }
            });
        }

        function selectTopic(lessonId, topicId) {
            const lesson = courseData.lessons.find(l => l.id === lessonId);
            const topic = lesson.topics.find(t => t.id === topicId);
            
            if (!lesson || !topic) return;

            currentLesson = lesson;
            currentTopic = topic;
            displayLessonContent(lesson, topic);
        }

        function displayLessonContent(lesson, topic) {
            const lessonDetail = document.getElementById('lessonDetail');
            
            const section = lesson.content.sections.find(s => s.title === topic.name);
            
            lessonDetail.innerHTML = `
                <h2>${lesson.content.title}</h2>
                <h3>${topic.name}</h3>
                <p>${section ? section.content : 'Nội dung đang được cập nhật...'}</p>
                <button class="complete-btn" onclick="completeTopic()" ${topic.completed ? 'disabled' : ''}>
                    ${topic.completed ? '✓ Đã hoàn thành' : '✓ Đánh dấu đã hoàn thành'}
                </button>
            `;
        }

        async function completeTopic() {
            if (!currentUser || !currentTopic || currentTopic.completed) return;

            try {
                const response = await fetch(`${API_CONFIG.BASE_URL}?action=updateProgress`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'updateProgress',
                        userId: currentUser.id,
                        topicId: currentTopic.id,
                        completed: true
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Update local data
                    currentTopic.completed = true;
                    
                    // Update progress in userProgress array
                    const existingProgress = userProgress.find(p => p.topicId === currentTopic.id);
                    if (existingProgress) {
                        existingProgress.completed = true;
                        existingProgress.completedDate = new Date();
                    } else {
                        userProgress.push({
                            userId: currentUser.id,
                            topicId: currentTopic.id,
                            completed: true,
                            completedDate: new Date()
                        });
                    }

                    // Update UI
                    const checkbox = document.getElementById(`checkbox-${currentLesson.id}-${currentTopic.id}`);
                    if (checkbox) {
                        checkbox.classList.add('checked');
                        checkbox.parentElement.classList.add('completed');
                    }
                    
                    updateProgress();
                    
                    // Update button
                    const btn = document.querySelector('.complete-btn');
                    btn.textContent = '✓ Đã hoàn thành!';
                    btn.disabled = true;

                    showSuccess('Đã đánh dấu hoàn thành!');
                } else {
                    showError('Có lỗi xảy ra khi cập nhật tiến độ');
                }
            } catch (error) {
                console.error('Error completing topic:', error);
                showError('Có lỗi xảy ra khi cập nhật tiến độ');
            }
        }

        function updateProgress() {
            if (!courseData) {
                document.getElementById('completedCount').textContent = '0';
                document.getElementById('totalCount').textContent = '0';
                document.getElementById('progressFill').style.width = '0%';
                return;
            }

            const totalTopics = courseData.lessons.reduce((total, lesson) => total + lesson.topics.length, 0);
            const completedCount = courseData.lessons.reduce((total, lesson) => 
                total + lesson.topics.filter(topic => topic.completed).length, 0);
            const progressPercent = totalTopics > 0 ? (completedCount / totalTopics) * 100 : 0;

            document.getElementById('completedCount').textContent = completedCount;
            document.getElementById('totalCount').textContent = totalTopics;
            document.getElementById('progressFill').style.width = `${progressPercent}%`;
        }

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================

        function showLoading(message = 'Đang tải...') {
            // You can implement a loading overlay here
            console.log(message);
        }

        function hideLoading() {
            // Hide loading overlay
            console.log('Loading complete');
        }

        function showError(message) {
            // Remove existing messages
            const existingMessages = document.querySelectorAll('.error, .success');
            existingMessages.forEach(msg => msg.remove());

            // Create error message
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            
            document.querySelector('.header').appendChild(errorDiv);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 5000);
        }

        function showSuccess(message) {
            // Remove existing messages
            const existingMessages = document.querySelectorAll('.error, .success');
            existingMessages.forEach(msg => msg.remove());

            // Create success message
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            
            document.querySelector('.header').appendChild(successDiv);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.parentNode.removeChild(successDiv);
                }
            }, 3000);
        }

        // ========================================
        // INITIALIZATION
        // ========================================

        document.addEventListener('DOMContentLoaded', () => {
            // Check for demo mode (when no backend URL is configured)
            if (API_CONFIG.BASE_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL') {
                document.getElementById('lessonList').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #e74c3c;">
                        <h4>Chế độ Demo</h4>
                        <p>Vui lòng cấu hình URL của Google Apps Script trong <code>API_CONFIG.BASE_URL</code> để sử dụng đầy đủ tính năng.</p>
                    </div>
                `;
            }
        });

        // Enable Enter key for login
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && (document.activeElement === document.getElementById('userEmail') || 
                document.activeElement === document.getElementById('userName'))) {
                loginUser();
            }
        });
    </script>
</body>
</html>